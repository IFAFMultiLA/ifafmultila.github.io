<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="viewport" content="width=device-width, initial-scale=1" />

      <title>Hosting learning applications and the web API</title>
    
          <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="_static/custom.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="_static/theme-vendors.js"></script> -->
      <script src="_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="genindex.html" />
  <link rel="search" title="Search" href="search.html" />
  <link rel="next" title="App deployment and data collection for learning analytics" href="trackingdata.html" />
  <link rel="prev" title="Creating learning applications" href="learning_apps.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="index.html" class="home-link">
    
      <span class="site-name">MultiLA software platform</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#table-of-contents">table of contents</a></span>
      </p>
      <ul class="current">
        
          <li class="toctree-l1 ">
            
              <a href="learning_apps.html" class="reference internal ">Creating learning applications</a>
            

            
          </li>

        
          <li class="toctree-l1 current">
            
              <a href="#" class="reference internal current">Hosting learning applications and the web API</a>
            

            
              <ul>
                
                  <li class="toctree-l2"><a href="#hosting-learning-applications" class="reference internal">Hosting learning applications</a></li>
                
                  <li class="toctree-l2"><a href="#setting-up-the-web-api-and-the-administration-interface" class="reference internal">Setting up the web API and the administration interface</a></li>
                
              </ul>
            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="trackingdata.html" class="reference internal ">App deployment and data collection for learning analytics</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="devguide.html" class="reference internal ">Extending the MultiLA software platform</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="codebook_raw_data.html" class="reference internal ">Codebook for MultiLA web API raw tracking data</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="codebook_prepared_data.html" class="reference internal ">Codebook for MultiLA prepared tracking data</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
    
    <li>Hosting learning applications and the web API</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="learning_apps.html"
       title="previous chapter">← Creating learning applications</a>
  </li>
  <li class="next">
    <a href="trackingdata.html"
       title="next chapter">App deployment and data collection for learning analytics →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="hosting-learning-applications-and-the-web-api">
<span id="serversetup"></span><h1>Hosting learning applications and the web API<a class="headerlink" href="#hosting-learning-applications-and-the-web-api" title="Link to this heading">¶</a></h1>
<p>This chapter is a guide server setup for the MultiLA software platform either on a server or a local development machine. Note that only Unix-based operating systems (Linux, MacOS) are covered by this guide. The software should run on Windows systems as well, but may require different setup steps.</p>
<section id="hosting-learning-applications">
<h2>Hosting learning applications<a class="headerlink" href="#hosting-learning-applications" title="Link to this heading">¶</a></h2>
<section id="server-setup">
<h3>Server setup<a class="headerlink" href="#server-setup" title="Link to this heading">¶</a></h3>
<p>The server needs to have R installed. It’s highly recommended to use <a class="reference external" href="https://rstudio.github.io/renv/">renv</a> during development and also for deployment, so you should install this package also on the server.</p>
<p>For hosting learning applications, you need to install and setup a Shiny server as explained in the <a class="reference external" href="https://docs.posit.co/shiny-server/">Shiny administrator’s guide</a>. You must also install a recent version of <a class="reference external" href="https://pandoc.org/">pandoc</a> on the server (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">pandoc</span></code> on Debian or Ubuntu based Linux systems).</p>
<p>In order to deliver the learning applications via HTTPS, you should run the Shiny applications through a proxy (as explained <a class="reference external" href="https://emeraldreverie.org/1/01/01/">this blog post</a>) such as Apache or Nginx. Make sure to use a valid SSL certificate for HTTPS, e.g. provided via <a class="reference external" href="https://letsencrypt.org/">Let’s Encrypt</a>. Configure the proxy to forward all HTTP requests to HTTPS.</p>
</section>
<section id="server-security-measures">
<h3>Server security measures<a class="headerlink" href="#server-security-measures" title="Link to this heading">¶</a></h3>
<p>If you’re hosting learning applications that include programming tasks, you should understand that anybody using your learning applications can run R code directly on your server. This has severe security implications, so you should make sure to have at least the following security measures in place:</p>
<ol class="arabic simple">
<li><p>The R process that runs the Shiny server (and hence the learning applications) should only have access to the learning applications. It’s best to create a separate user for that process (or even for each learning application) and then follow the Shiny server setup guide on <a class="reference external" href="https://docs.posit.co/shiny-server/#host-per-user-application-directories">Per-User Application Directories</a> and <a class="reference external" href="https://docs.posit.co/shiny-server/#let-users-manage-their-own-applications">User Managed Applications</a>.</p></li>
<li><p>Restrict R code execution on the server via RApparmor (see <a class="reference external" href="https://rstudio.github.io/learnr/articles/publishing.html#start-and-cleanup-hooks">learnr documentation</a>) and consider using a custom AppArmor profile for R code exercises (see <a class="reference external" href="https://github.com/jeroen/RAppArmor">RAppArmor documentation</a>).</p></li>
</ol>
<p>For maximum security, you can also consider running each learning application inside a separate Docker container. Setting this up is however beyond the scope of this documentation.</p>
<p>Deploying a learning application and registering it in the backend system is explained in chapter “<a class="reference internal" href="trackingdata.html#tracking-data"><span class="std std-ref">App deployment and data collection for learning analytics</span></a>”.</p>
</section>
</section>
<section id="setting-up-the-web-api-and-the-administration-interface">
<span id="backend-installation"></span><h2>Setting up the web API and the administration interface<a class="headerlink" href="#setting-up-the-web-api-and-the-administration-interface" title="Link to this heading">¶</a></h2>
<p>The following instructions all refer to the <em>webapi</em> component of the MultiLA software platform, which is a <a class="reference external" href="https://www.djangoproject.com/">Django</a> web application running inside a docker container. You must initially clone the current version from its <a class="reference external" href="https://github.com/IFAFMultiLA/webapi">GitHub repository</a>. The administration interface supports the option to deploy apps directly via upload, which however requires some more setup work. The respective steps for enabling this feature are explained under “<a class="reference internal" href="#setup-app-upload"><span class="std std-ref">(Optional) App upload feature</span></a>”.</p>
<section id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h3>
<p>In order to deploy the MultiLA web API and administration interface, you need access to a server with the following things installed and set up:</p>
<ul class="simple">
<li><p>Docker with Docker Compose v2 (recommended: run Docker in <em>rootless</em> mode),</p></li>
<li><p>an HTTP service such as Apache or nginx used as proxy and for delivering static files,</p></li>
<li><p>a valid SSL certificate – <strong>only run this service via HTTPS in production!</strong>.</p></li>
</ul>
</section>
<section id="initial-deployment">
<h3>Initial deployment<a class="headerlink" href="#initial-deployment" title="Link to this heading">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The following manual assumes that you have an understanding of the command-line interface and permissions system used on Linux servers. The manual doesn’t go into detail about setting up the correct directory and file permissions, so that the server setup is secure. <strong>If you’re unsure about how to set up a Linux server in a secure way, you should get help from an expert.</strong></p>
</div>
<p>Make sure that you’ve cloned the <a class="reference external" href="https://github.com/IFAFMultiLA/webapi">webapi GitHub repository</a> locally and change to the directory of the cloned repository in your terminal.</p>
<ol class="arabic simple">
<li><p>Create a Docker Compose configuration like the following as <code class="docutils literal notranslate"><span class="pre">docker/compose_prod.yml</span></code>:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># # optional: DB admin web interface accessible on local port 8081</span>
<span class="w">  </span><span class="c1"># adminer:</span>
<span class="w">  </span><span class="c1">#  image: adminer</span>
<span class="w">  </span><span class="c1">#  ports:</span>
<span class="w">  </span><span class="c1">#    - 127.0.0.1:8081:8080</span>
<span class="w">  </span><span class="c1">#  restart: always</span>

<span class="w">  </span><span class="nt">db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../data/db:/var/lib/postgresql/data&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../data/backups:/data_backup&#39;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_USER=admin&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_PASSWORD=&lt;CHANGE_THIS&gt;&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_DB=multila&#39;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>

<span class="w">  </span><span class="nt">web</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">..</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./docker/Dockerfile_prod</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python -m uvicorn --host 0.0.0.0 --port 8000 multila.asgi:application</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../src:/code&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../data/export:/data_export&#39;</span>
<span class="w">      </span><span class="c1"># optional for app upload feature: path where deployed apps should be placed</span>
<span class="w">      </span><span class="c1"># on your server</span>
<span class="w">      </span><span class="c1"># - &#39;&lt;PATH_TO_APP_UPLOAD_DIRECTORY&gt;:/apps_deployed&#39;</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8000:8000&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;BASE_URL=&lt;SET_BASE_URL_HERE&gt;&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;ALLOWED_HOSTS=&lt;SET_SERVER_IP_HERE&gt;&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_USER=admin&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_PASSWORD=&lt;CHANGE_THIS&gt;&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_DB=multila&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;DJANGO_SETTINGS_MODULE=multila.settings_prod&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;SECRET_KEY=&lt;CHANGE_THIS&gt;&#39;</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">src/manage.py</span> <span class="pre">collectstatic</span></code> inside the repository root directory to copy all static files to the <code class="docutils literal notranslate"><span class="pre">static_files</span></code> directory. Then upload all files to your server, e.g. to a directory <code class="docutils literal notranslate"><span class="pre">~/webapi</span></code>.</p></li>
<li><p>Log in to the server. Create the directory <code class="docutils literal notranslate"><span class="pre">/var/www/api_static_files/</span></code> – this is the directory, where “static files” such as CSS files or images for the administration interface will be located.</p></li>
<li><p>Change the directory to the location of the uploaded web API source (i.e. <code class="docutils literal notranslate"><span class="pre">~/webapi</span></code>). Then do the following:</p></li>
</ol>
<ul class="simple">
<li><p>copy the static files via <code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">-r</span> <span class="pre">static_files/*</span> <span class="pre">/var/www/api_static_files/</span></code> (you must have the permissions to do so)</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">build</span> <span class="pre">--no-cache</span></code> to build the web API container</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">create</span></code> to create all necessary containers</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">up</span> <span class="pre">-d</span></code> to launch the containers</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">exec</span> <span class="pre">web</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code> to initialize the DB</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">exec</span> <span class="pre">web</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">createsuperuser</span></code> to create a backend admin user; this is the password used for the first login to the administration interface – <strong>use a secure password</strong></p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">exec</span> <span class="pre">web</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">check</span> <span class="pre">--deploy</span></code> to check the deployment</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">exec</span> <span class="pre">web</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">test</span> <span class="pre">api</span></code> to run the tests in the deployment environment</p></li>
<li><p>you may run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">logs</span> <span class="pre">-f</span></code> to view the logs and/or <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://0.0.0.0:8000/</span></code> to check if the web server is running</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p>On the server, setup your HTTP service (e.g. Apache or nginx) to do two tasks: 1) it must serve the static files at <code class="docutils literal notranslate"><span class="pre">/var/www/api_static_files</span></code> and 2) it must forward HTTP requests from outside to the server on to the docker container that runs the web application (proxy server).</p></li>
</ol>
<p>An example configuration for the Apache webserver that delivers static files at <code class="docutils literal notranslate"><span class="pre">https://&lt;HOST&gt;/api_static_files/</span></code> and forwards all requests at <code class="docutils literal notranslate"><span class="pre">https://&lt;HOST&gt;/api/</span></code> to the Docker container would use the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># setup static files (and prevent them to be passed through the proxy)
ProxyPass /api_static_files !
Alias /api_static_files /var/www/api_static_files

# setup proxy for API
ProxyPass /api/ http://0.0.0.0:8000/
ProxyPassReverse /api/ http://0.0.0.0:8000/
</pre></div>
</div>
<p>All requests to <code class="docutils literal notranslate"><span class="pre">https://&lt;SERVER&gt;/api/</span></code> should then be forwarded to the web application.</p>
<p>Check that the deployment of the web API was successful by visiting <code class="docutils literal notranslate"><span class="pre">https://&lt;SERVER&gt;/api/admin/</span></code> and entering your backend admin user credentials from the <code class="docutils literal notranslate"><span class="pre">createsuperuser</span></code> step above.</p>
</section>
<section id="optional-publishing-updates">
<h3>(Optional) Publishing updates<a class="headerlink" href="#optional-publishing-updates" title="Link to this heading">¶</a></h3>
<p>In case there are updates to the web API component, you can do the following:</p>
<ul class="simple">
<li><p>If there are changes in the static files, you should run <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">src/manage.py</span> <span class="pre">collectstatic</span></code> locally first.</p></li>
<li><p>Publish updated files to the server (it’s recommended to use <code class="docutils literal notranslate"><span class="pre">rsync</span></code> for that).</p></li>
<li><p>If there are changes in the static files, you need to copy the static files via <code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">-r</span> <span class="pre">static_files/*</span> <span class="pre">/var/www/api_static_files/</span></code> on the server.</p></li>
<li><p>On the server, optional run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">exec</span> <span class="pre">web</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code> to update the database.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">-f</span> <span class="pre">docker/compose_prod.yml</span> <span class="pre">restart</span> <span class="pre">web</span></code> to restart the web application.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If there are changes in the dependencies, you need to rebuild the container as decribed above under <em>Initial deployment</em>, point 4.</p>
</div>
</section>
<section id="optional-db-administration-interface">
<h3>(Optional) DB administration interface<a class="headerlink" href="#optional-db-administration-interface" title="Link to this heading">¶</a></h3>
<p>If you have enabled the <code class="docutils literal notranslate"><span class="pre">adminer</span></code> service in the docker compose file above, a small DB administration web interface
is running on port 8081 on the server. For security reasons, it is only accessible from localhost, i.e. you need to set
up an SSH tunnel to make it available remotely from your machine. You can do so on your machine by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">L</span> <span class="mi">8081</span><span class="p">:</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">&lt;</span><span class="n">USER</span><span class="o">&gt;@&lt;</span><span class="n">SERVER</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>, where <code class="docutils literal notranslate"><span class="pre">&lt;USER&gt;&#64;&lt;SERVER&gt;</span></code> are the login name and the host name of the server, where docker containers are running.
You can then go to <code class="docutils literal notranslate"><span class="pre">http://localhost:8081/</span></code> in your
browser and login to the Postgres server (not MySQL!) using the <code class="docutils literal notranslate"><span class="pre">POSTGRES_USER</span></code> and <code class="docutils literal notranslate"><span class="pre">POSTGRES_PASSWORD</span></code> listed in
the environment variabless of the docker compose file.</p>
</section>
<section id="optional-db-backups">
<h3>(Optional) DB backups<a class="headerlink" href="#optional-db-backups" title="Link to this heading">¶</a></h3>
<p>You can use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">compose</span> <span class="o">-</span><span class="n">f</span> <span class="n">docker</span><span class="o">/</span><span class="n">compose_prod</span><span class="o">.</span><span class="n">yml</span> <span class="n">exec</span> <span class="n">db</span> \
    <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;pg_dump -U admin -F c multila </span><span class="se">\</span>
<span class="s1">    &gt; /data_backup/multila-`date -Is | sed &quot;s/://g&quot; | cut -d+ -f 1`.pgdump&#39;</span>
</pre></div>
</div>
<p>on the server to generate a PostgreSQL database dump with the current timestamp under <code class="docutils literal notranslate"><span class="pre">data/backups/</span></code>. It’s advisable to run this command regularly, e.g. via a cronjob, and then copy the database dumps to a backup destination.</p>
</section>
<section id="optional-chatbot-feature">
<h3>(Optional) Chatbot feature<a class="headerlink" href="#optional-chatbot-feature" title="Link to this heading">¶</a></h3>
<p>The MultiLA platform allows to integrate a chatbot in the learning apps as an adaptive learning assistant. The backend will communicate with a chat API provider for this purpose, e.g. with OpenAI’s GPT model API. So far, only chat APIs that use OpenAI’s web API format are supported (so hosting your own model via LM Studio for example works).</p>
<p>To set up this feature, you will need to edit the <code class="docutils literal notranslate"><span class="pre">src/multila/settings_prod.py</span></code> file of the web API backend and replace <code class="docutils literal notranslate"><span class="pre">CHATBOT_API</span> <span class="pre">=</span> <span class="pre">None</span></code> with the following code that you need to adapt to your set up (see code comments below):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CHATBOT_API</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># create a dictionary where labels map to provider options</span>
    <span class="s2">&quot;providers&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># note that the label is not allowed to use the string &#39; | &#39;</span>
        <span class="c1"># this is an example using OpenAI&#39;s services</span>
        <span class="s2">&quot;openai&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">),</span>
            <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
            <span class="s2">&quot;available_models&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">],</span>
        <span class="p">},</span>
        <span class="c1"># this is an example of how to use a self-hosted service using LM studio</span>
        <span class="s2">&quot;lm-studio&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;not needed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>  <span class="c1"># LM studio uses the OpenAI API format</span>
            <span class="s2">&quot;setup_options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MY_LLM_SERVER&quot;</span><span class="p">)},</span>
            <span class="s2">&quot;request_options&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="s2">&quot;available_models&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="c1"># list your installed models here</span>
                <span class="o">...</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
        <span class="c1"># set more providers here</span>
    <span class="p">},</span>
    <span class="s2">&quot;content_section_identifier_pattern&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;mainContentElem-\d+$&quot;</span><span class="p">,</span>
     <span class="c1"># default system role prompt template per language</span>
     <span class="c1"># use $doc_text placeholder to include the app&#39;s text representation in the prompt</span>
    <span class="s2">&quot;system_role_templates&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;en&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a teacher in data science and statistics. Consider the following learning material enclosed &quot;</span>
        <span class="s1">&#39;by &quot;---&quot; marks. Before each content section in the document, there is a unique identifier for that &#39;</span>
        <span class="s1">&#39;section denoted as &quot;mainContentElem-#&quot;. &quot;#&quot; is a placeholder for a number.&#39;</span>
        <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">$doc_text</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">Now give a short answer to the following question and, if possible, refer to &quot;</span>
        <span class="s2">&quot;the learning material. If you are referring to the learning material, end your answer with a new paragraph &quot;</span>
        <span class="s1">&#39;containing only &quot;mainContentElem-#&quot; and replace &quot;#&quot; with the respective section number.&#39;</span><span class="p">,</span>
        <span class="s2">&quot;de&quot;</span><span class="p">:</span> <span class="s2">&quot;Du bist Lehrkraft im Bereich Data Science und Statistik. Berücksichtige das folgende &quot;</span>
        <span class="s1">&#39;Lehrmaterial, das durch &quot;---&quot;-Markierungen eingeschlossen ist. Vor jedem Inhaltsabschnitt im Dokument &#39;</span>
        <span class="s1">&#39;gibt es eine eindeutige Kennung für diesen Abschnitt, die mit &quot;mainContentElem-#&quot; angegeben ist. &quot;#&quot; &#39;</span>
        <span class="s2">&quot;ist ein Platzhalter für eine Zahl.</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">$doc_text</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">Gib nun eine kurze Antwort auf &quot;</span>
        <span class="s2">&quot;die folgende Frage und beziehe dich, wenn möglich, auf das Lehrmaterial. Wenn du dich auf das &quot;</span>
        <span class="s2">&quot;Lehrmaterial beziehst, beende deine Antwort mit einem neuen Absatz, der ausschließlich den Text &quot;</span>
        <span class="s1">&#39;&quot;mainContentElem-#&quot; enthält und ersetze &quot;#&quot; durch die entsprechende Abschnittsnummer.&#39;</span><span class="p">,</span>
    <span class="p">},</span>
     <span class="c1"># default user role prompt template per language</span>
     <span class="c1"># use $doc_text placeholder to include the app&#39;s text representation in the prompt and $question for the</span>
     <span class="c1"># actual user message</span>
    <span class="s2">&quot;user_role_templates&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;en&quot;</span><span class="p">:</span> <span class="s2">&quot;$question&quot;</span><span class="p">,</span>
        <span class="s2">&quot;de&quot;</span><span class="p">:</span> <span class="s2">&quot;$question&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any environment variable such as <code class="docutils literal notranslate"><span class="pre">&quot;OPENAI_API_KEY&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;MY_LLM_SERVER&quot;</span></code> used in the settings file above needs to be added to the Docker Compose configuration in the <code class="docutils literal notranslate"><span class="pre">environment:</span></code> section of the “web” container with its respective value.</p>
</div>
<p>After restarting the web service container, a new option labelled “Enable chatbot choosing a provider and model” will appear in the administration interface for all application configurations.</p>
</section>
<section id="optional-app-upload-feature">
<span id="setup-app-upload"></span><h3>(Optional) App upload feature<a class="headerlink" href="#optional-app-upload-feature" title="Link to this heading">¶</a></h3>
<p>In order to use the app upload feature, you first need to create a directory on the server, where uploaded apps will be placed. Hence this directory must be writable for the user that runs the <em>webapi</em> docker container and also for the user that runs the Shiny server. This directory will be called <code class="docutils literal notranslate"><span class="pre">&lt;APP_UPLOAD_DIRECTORY&gt;</span></code> below.</p>
<p>Next, you need to edit the Docker Compose configuration <code class="docutils literal notranslate"><span class="pre">docker/compose_prod.yml</span></code> to add the following environment variables for the <code class="docutils literal notranslate"><span class="pre">web</span></code> container:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">services</span><span class="p">:</span>

<span class="w">  </span><span class="c1"># [ other services ... ]</span>

<span class="w">  </span><span class="nt">web</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># [ other directives ... ]</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># [ other directives ... ]</span>
<span class="w">      </span><span class="c1"># path where deployed apps should be placed on your server</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;APP_UPLOAD_PATH=&lt;APP_UPLOAD_DIRECTORY&gt;&#39;</span>
<span class="w">      </span><span class="c1"># path to app logs (usually &quot;log&quot; inside the upload directory)</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;APP_LOG_PATH=&lt;APP_UPLOAD_DIRECTORY&gt;/log&#39;</span>
<span class="w">      </span><span class="c1"># base URL for all apps, i.e. the Shiny server URL</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;APP_BASE_URL=&lt;BASE_URL_FOR_UPLOADED_APPS&gt;&#39;</span>
<span class="w">      </span><span class="c1"># app removal mode; if &quot;delete&quot;, remove the whole app directory; if</span>
<span class="w">      </span><span class="c1"># &quot;remove.txt&quot; write a remove.txt file in the app directory; otherwise</span>
<span class="w">      </span><span class="c1"># do nothing</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;APP_REMOVE_MODE=remove.txt&#39;</span>
<span class="w">      </span><span class="c1"># optional path to a &quot;trigger file&quot; that is updated (via &quot;touch&quot;) whenever</span>
<span class="w">      </span><span class="c1"># there was a change to any deployed app</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;APP_UPLOAD_TRIGGER_FILE=&lt;APP_UPLOAD_DIRECTORY&gt;/update&#39;</span>
</pre></div>
</div>
<p>Don’t forget to recreate and relaunch the container after these changes. You should now see an “Upload app” field in the “Add application” form. If the file permissions are correctly set, uploading an app should already work. Next, we must set up a service, that will manage the actual deployment of the apps once they’re uploaded or removed.</p>
<p>For this, we first create a management shell script that iterates through all apps in <code class="docutils literal notranslate"><span class="pre">&lt;APP_UPLOAD_DIRECTORY&gt;</span></code> and performs the management operations that are indicated by special files like <code class="docutils literal notranslate"><span class="pre">install.txt</span></code>. Set <code class="docutils literal notranslate"><span class="pre">&lt;USER&gt;</span></code> to the system user that runs the Shiny apps. Set <code class="docutils literal notranslate"><span class="pre">&lt;GROUP&gt;</span></code> to the system group that should own the app directories. Also, create a directory for deleted apps and set the path in <code class="docutils literal notranslate"><span class="pre">&lt;GRAVEYARD_PATH&gt;</span></code>. Alternatively, set this variable to an empty string to directly remove the files of deleted apps.</p>
<p>The following script is named <code class="docutils literal notranslate"><span class="pre">manage_deployed_apps.sh</span></code> and will be run as root, so you can place it for example in <code class="docutils literal notranslate"><span class="pre">/root/bin</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">target_usr</span><span class="o">=</span>&lt;USER&gt;
<span class="nv">target_grp</span><span class="o">=</span>&lt;GROUP&gt;
<span class="nv">target_permissions</span><span class="o">=</span><span class="m">0775</span>
<span class="nv">graveyard_path</span><span class="o">=</span><span class="s2">&quot;&lt;GRAVEYARD_PATH&gt;&quot;</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$graveyard_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$graveyard_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;error: graveyard_path is set to &#39;</span><span class="nv">$graveyard_path</span><span class="s2">&#39; but this directory doesn&#39;t exist.&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Check if an argument is given</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;error: no path provided.&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;usage: </span><span class="nv">$0</span><span class="s2"> &lt;path&gt;&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="nv">deploy_path</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="c1"># Check if the path exists</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$deploy_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;error: the path &#39;</span><span class="nv">$deploy_path</span><span class="s2">&#39; does not exist.&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;searching for apps in &#39;</span><span class="nv">$deploy_path</span><span class="s2">&#39; that require an action ...&quot;</span>

<span class="c1"># Iterate through all folders in the given path and print the folder names</span>
<span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>app<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">/remove.txt&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">baseapp</span><span class="o">=</span><span class="sb">`</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">&quot;</span><span class="sb">`</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$graveyard_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&gt; removing app &#39;</span><span class="nv">$baseapp</span><span class="s2">&#39; ...&quot;</span>
<span class="w">            </span>rm<span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&gt; moving app &#39;</span><span class="nv">$baseapp</span><span class="s2">&#39; to graveyard ...&quot;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$baseapp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>*<span class="s2">&quot;~old-&quot;</span>*<span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">               </span><span class="nv">app_graveyard</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$graveyard_path</span><span class="s2">/</span><span class="nv">$baseapp</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">               </span><span class="nv">app_graveyard</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$graveyard_path</span><span class="s2">/</span><span class="nv">$baseapp</span><span class="s2">-`date -Is`&quot;</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">            </span>mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app_graveyard</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">/install.txt&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">/renv.lock&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&gt; installing dependencies for &#39;</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&#39; ...&quot;</span>

<span class="w">        </span>chown<span class="w"> </span>-R<span class="w"> </span><span class="nv">$target_usr</span>:<span class="nv">$target_grp</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">&quot;</span>

<span class="w">        </span>runuser<span class="w"> </span>-<span class="w"> </span><span class="nv">$target_usr</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;(cd </span><span class="nv">$app</span><span class="s2"> &amp;&amp; R -e &#39;renv::activate()&#39; &amp;&amp; R -e &#39;renv::restore()&#39;)&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$app</span>/install.log<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>runuser<span class="w"> </span>-<span class="w"> </span><span class="nv">$target_usr</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;rm </span><span class="nv">$app</span><span class="s2">/install.txt&quot;</span>
<span class="w">            </span>runuser<span class="w"> </span>-<span class="w"> </span><span class="nv">$target_usr</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;rm -f </span><span class="nv">$app</span><span class="s2">/install_error.txt&quot;</span>
<span class="w">            </span>runuser<span class="w"> </span>-<span class="w"> </span><span class="nv">$target_usr</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;touch </span><span class="nv">$app</span><span class="s2">/restart.txt&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&gt;&gt; done.&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span>runuser<span class="w"> </span>-<span class="w"> </span><span class="nv">$target_usr</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;touch </span><span class="nv">$app</span><span class="s2">/install_error.txt&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&gt;&gt; installing dependencies failed. check </span><span class="nv">$app</span><span class="s2">/install.log file.&quot;</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span>chown<span class="w"> </span>-R<span class="w"> </span><span class="nv">$target_usr</span>:<span class="nv">$target_grp</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">&quot;</span>
<span class="w">        </span>chmod<span class="w"> </span><span class="nv">$target_permissions</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$app</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>find<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$deploy_path</span><span class="s2">&quot;</span><span class="w"> </span>-mindepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>-maxdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-print0<span class="o">)</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;done.&quot;</span>
</pre></div>
</div>
<p>Next, we create a service that runs the above script every time the <em>trigger file</em> defined in the <code class="docutils literal notranslate"><span class="pre">APP_UPLOAD_TRIGGER_FILE</span></code> variable of the Docker Compose file above is updated. For this, you need to make sure that <em>inotify</em> is installed on the server (the package is named <code class="docutils literal notranslate"><span class="pre">inotify-tools</span></code> on Debian-based Linux systems). We then create a bash script named <code class="docutils literal notranslate"><span class="pre">manage_deployed_apps-service.sh</span></code>, which will also be run as root and can be placed in <code class="docutils literal notranslate"><span class="pre">/root/bin</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">deploy_path</span><span class="o">=</span><span class="s2">&quot;&lt;APP_UPLOAD_DIRECTORY&gt;&quot;</span>
<span class="nv">watch_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$deploy_path</span><span class="s2">/update&quot;</span>
<span class="nv">watch_file_owner</span><span class="o">=</span>&lt;USER&gt;
<span class="nv">mgmt_script</span><span class="o">=</span>/root/bin/manage_deployed_apps.sh

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$deploy_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;cannot access app deployment directory &#39;</span><span class="nv">$deploy_path</span><span class="s2">&#39;&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

touch<span class="w"> </span><span class="nv">$watch_file</span>
chown<span class="w"> </span><span class="nv">$watch_file_owner</span>:<span class="nv">$watch_file_owner</span><span class="w"> </span><span class="nv">$watch_file</span>
inotifywait<span class="w"> </span>-m<span class="w"> </span>--format<span class="w"> </span><span class="s1">&#39;%e %w %f&#39;</span><span class="w"> </span><span class="nv">$watch_file</span><span class="w"> </span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>event<span class="w"> </span>dir<span class="w"> </span>filename<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>./<span class="nv">$mgmt_script</span><span class="w"> </span><span class="nv">$deploy_path</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Finally, we create a systemd service (if your server doesn’t use systemd for service management, you must adapt the following steps for your respective service management software). For this, we first create a file <code class="docutils literal notranslate"><span class="pre">/lib/systemd/system/multila_manage_deployed_apps.service</span></code> as root with the following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">MultiLA</span> <span class="n">watch</span> <span class="n">script</span> <span class="k">for</span> <span class="n">managing</span> <span class="n">apps</span> <span class="n">deployed</span> <span class="n">via</span> <span class="n">admin</span> <span class="n">web</span> <span class="n">interface</span><span class="o">.</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">root</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">manage_deployed_apps</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">sh</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>Then we enable and start the service (also as root):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">multila_manage_deployed_apps</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">multila_manage_deployed_apps</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>Check that the service works by running <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">multila_manage_deployed_apps.service</span></code> and by uploading an app via the administration interface. You can see the log for this service with the command <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">multila_manage_deployed_apps.service</span> <span class="pre">-b</span></code>.</p>
</section>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="learning_apps.html"
       title="previous chapter">← Creating learning applications</a>
  </li>
  <li class="next">
    <a href="trackingdata.html"
       title="next chapter">App deployment and data collection for learning analytics →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2024, Markus Konrad.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.2.6 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>